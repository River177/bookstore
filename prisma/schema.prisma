// Prisma Schema for Online Bookstore
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// Part 1: User Client Tables
// ==========================================

/// 用户表
model User {
  id          Int       @id @default(autoincrement()) @map("user_id")
  username    String    @unique @db.VarChar(50)
  password    String    @db.VarChar(255)
  email       String    @unique @db.VarChar(100)
  fullName    String    @map("full_name") @db.VarChar(100)
  phone       String?   @db.VarChar(20)
  address     String?   @db.VarChar(255)
  city        String?   @db.VarChar(50)
  postalCode  String?   @map("postal_code") @db.VarChar(20)
  status      Int       @default(1) @db.SmallInt
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  cart   ShoppingCart?
  orders Order[]

  @@map("users")
}

/// 图书分类表
model Category {
  id          Int     @id @default(autoincrement()) @map("category_id")
  name        String  @db.VarChar(50)
  description String? @db.VarChar(255)

  // Relations
  books Book[]

  @@map("categories")
}

/// 图书表
model Book {
  id            Int      @id @default(autoincrement()) @map("book_id")
  isbn          String   @unique @db.VarChar(20)
  title         String   @db.VarChar(200)
  author        String   @db.VarChar(100)
  publisher     String?  @db.VarChar(100)
  price         Decimal  @db.Decimal(10, 2)
  stockQuantity Int      @default(0) @map("stock_quantity")
  description   String?  @db.Text
  coverImage    String?  @map("cover_image") @db.VarChar(255)
  categoryId    Int?     @map("category_id")
  status        Int      @default(1) @db.SmallInt
  salesCount    Int      @default(0) @map("sales_count")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  category   Category?   @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  cartItems  CartItem[]
  orderItems OrderItem[]
  stockLogs  StockLog[]

  @@index([categoryId])
  @@index([title])
  @@index([author])
  @@map("books")
}

/// 购物车表
model ShoppingCart {
  id        Int      @id @default(autoincrement()) @map("cart_id")
  userId    Int      @unique @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]

  @@map("shopping_carts")
}

/// 购物车项表
model CartItem {
  id       Int      @id @default(autoincrement()) @map("cart_item_id")
  cartId   Int      @map("cart_id")
  bookId   Int      @map("book_id")
  quantity Int      @default(1)
  addedAt  DateTime @default(now()) @map("added_at")

  // Relations
  cart ShoppingCart @relation(fields: [cartId], references: [id], onDelete: Cascade)
  book Book         @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([cartId, bookId])
  @@map("cart_items")
}

/// 订单表
model Order {
  id              Int      @id @default(autoincrement()) @map("order_id")
  userId          Int      @map("user_id")
  totalAmount     Decimal  @map("total_amount") @db.Decimal(10, 2)
  status          String   @default("pending") @db.VarChar(20)
  shippingAddress String   @map("shipping_address") @db.VarChar(255)
  orderDate       DateTime @default(now()) @map("order_date")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  user  User        @relation(fields: [userId], references: [id], onDelete: Restrict)
  items OrderItem[]

  @@index([userId])
  @@index([status])
  @@index([orderDate])
  @@map("orders")
}

/// 订单项表
model OrderItem {
  id        Int     @id @default(autoincrement()) @map("order_item_id")
  orderId   Int     @map("order_id")
  bookId    Int     @map("book_id")
  quantity  Int
  unitPrice Decimal @map("unit_price") @db.Decimal(10, 2)

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  book  Book  @relation(fields: [bookId], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@index([bookId])
  @@map("order_items")
}

// ==========================================
// Part 2: Admin Tables
// ==========================================

/// 管理员表
model Admin {
  id          Int       @id @default(autoincrement()) @map("admin_id")
  username    String    @unique @db.VarChar(50)
  password    String    @db.VarChar(255)
  email       String    @unique @db.VarChar(100)
  fullName    String    @map("full_name") @db.VarChar(100)
  phone       String?   @db.VarChar(20)
  status      Int       @default(1) @db.SmallInt
  lastLoginAt DateTime? @map("last_login_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  roles         AdminRole[]
  operationLogs OperationLog[]

  @@map("admins")
}

/// 角色表
model Role {
  id          Int      @id @default(autoincrement()) @map("role_id")
  roleName    String   @unique @map("role_name") @db.VarChar(50)
  roleKey     String   @unique @map("role_key") @db.VarChar(50)
  description String?  @db.VarChar(255)
  status      Int      @default(1) @db.SmallInt
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  admins AdminRole[]

  @@map("roles")
}

/// 管理员-角色关联表
model AdminRole {
  id        Int      @id @default(autoincrement())
  adminId   Int      @map("admin_id")
  roleId    Int      @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)
  role  Role  @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([adminId, roleId])
  @@map("admin_roles")
}

/// 操作日志表
model OperationLog {
  id         BigInt   @id @default(autoincrement()) @map("log_id")
  adminId    Int?     @map("admin_id")
  adminName  String?  @map("admin_name") @db.VarChar(50)
  module     String   @db.VarChar(50)
  action     String   @db.VarChar(50)
  targetType String?  @map("target_type") @db.VarChar(50)
  targetId   Int?     @map("target_id")
  content    String?  @db.Text
  status     Int      @default(1) @db.SmallInt
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  admin Admin? @relation(fields: [adminId], references: [id], onDelete: SetNull)

  @@index([adminId])
  @@index([module])
  @@index([action])
  @@index([createdAt])
  @@map("operation_logs")
}

/// 库存变动记录表
model StockLog {
  id             BigInt   @id @default(autoincrement()) @map("log_id")
  bookId         Int      @map("book_id")
  changeType     String   @map("change_type") @db.VarChar(20)
  changeQuantity Int      @map("change_quantity")
  beforeQuantity Int      @map("before_quantity")
  afterQuantity  Int      @map("after_quantity")
  relatedOrderId Int?     @map("related_order_id")
  operatorId     Int?     @map("operator_id")
  operatorType   String   @default("admin") @map("operator_type") @db.VarChar(10)
  remark         String?  @db.VarChar(255)
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([bookId])
  @@index([changeType])
  @@index([createdAt])
  @@map("stock_logs")
}
